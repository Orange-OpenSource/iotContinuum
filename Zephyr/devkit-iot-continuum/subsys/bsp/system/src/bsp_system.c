// Copyright (C) Lacroix Impulse 2023 (France)
// SPDX-License-Identifier: Apache-2.0

/**
 * @file
 * @brief   BSP for for system services
 */

// -------------------------------------------------------------------------------------------------------- //
//
//                            INCLUDED FILES
//
// -------------------------------------------------------------------------------------------------------- //
#include <zephyr/kernel.h>
#include <zephyr/sys/reboot.h>

// -------------------------------------------------------------------------------------------------------- //
//
//                            MACRO DECLARATION
//
// -------------------------------------------------------------------------------------------------------- //
/// @brief Registering bsp_system for log
LOG_MODULE_REGISTER(bsp_system, CONFIG_BSP_SYSTEM_LOG_LEVEL);

// -------------------------------------------------------------------------------------------------------- //
//
//                         LOCAL TYPE DEFINITIONS AND DATA STRUCTURES
//
// -------------------------------------------------------------------------------------------------------- //

// -------------------------------------------------------------------------------------------------------- //
//
//                            LOCAL VARIABLES
//
// -------------------------------------------------------------------------------------------------------- //

// -------------------------------------------------------------------------------------------------------- //
//
//                            LOCAL CONSTANTS
//
// -------------------------------------------------------------------------------------------------------- //

// -------------------------------------------------------------------------------------------------------- //
//
//                            LOCAL FUNCTIONS DECLARATION
//
// -------------------------------------------------------------------------------------------------------- //

// -------------------------------------------------------------------------------------------------------- //
//
//                            EXTERNAL FUNCTIONS DEFINITION
//
// -------------------------------------------------------------------------------------------------------- //

BSP_Ret_e BSP_SYSTEM_GetUptimeSec(uint32_t *o_pui32_Sec)
{
   *o_pui32_Sec = (uint32_t)(k_uptime_get_32() / 1000);
   LOG_DBG("Uptime = %u sec", *o_pui32_Sec);

   return BSP_RET_SUCCESS;
}

BSP_Ret_e BSP_SYSTEM_GetUptimeMs(uint64_t *o_pui64_Ms)
{
   // TODO <CUDO> need to improve to handle overflow in 49.7 days after startup
   *o_pui64_Ms = (uint64_t)(k_uptime_get_32());
   LOG_DBG("Uptime = %llu ms", *o_pui64_Ms);

   return BSP_RET_SUCCESS;
}

BSP_Ret_e BSP_SYSTEM_Reboot(uint32_t i_ui32_Delay_ms)
{
   LOG_DBG("Do a software reset in %u ms", i_ui32_Delay_ms);
   k_sleep(K_MSEC(i_ui32_Delay_ms));

   sys_reboot(SYS_REBOOT_WARM);

   return BSP_RET_SUCCESS;
}
